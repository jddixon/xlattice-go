# The XLReg Protocol

## Hello and Reply

All communications with the XLReg server must begin with a Hello/Reply
exchange, which verifies to the client the identity of the server and
establishes the AES IV and key used to encrypt further message 
exchanges between the XLReg server and client.

### Version Numbers

XLReg version numbers are 4-byte little-endian values.  These may be 
thought of as `a.b.c.d`, where `a`, `b`, `c`, and `d` are unsigned byte values.
`d` is the lowest value and so will appear first in wire format.  When 
serialized as strings, version numbers are conventionally written in 
big-endian form, except that if the low-order fields are all zero, only
the high-order fields appear, so `1.2.0.0` will normally be written `1.2` 
(but will appear on the wire as `0.0.2.1`.  Similarly `1.2.3.0` serializes
as `1.2.3` but appears on the wire as `0.3.2.1` and `1.2.3.4` appears on
the wire as `4.3.2.1.

### Hello

XLReg communications begin when one machine, the **client**,
sends a Hello message to another, the **server** in this context.  The
Hello message consists of 

* a 16-byte AES initialization vector (IV)
* a 32-byte AES key
* an 8 byte salt (random value)
* a 4-byte little-endian version number

AES is a block cipher used for high speed encryption.  AES has a standard
block size of 16 bytes.  The key is a whole number of such blocks.  The IV is
used to set up cipher-block chaining (CBC), a mode of operation in which
each block of plaintext is XORed with the previous block of ciphertext 
before encryption.  The first block of plaintext has no previous block 
of ciphertext, so an IV is used instead.

Clients should encrypt the message using RSA-OAEP, SHA1, and a 20-byte
random value, the oaepSalt.  No label is used.  In Go this is done using
	ciphertext,err = rsa.EncryptOAEP(sha, oaepSalt, ck, data, nil)
where `sha` represents an instance of the SHA1 hash function and `ck` is
an RSA public key.

In production all of the random values (IV, key, salt, and oaepSalt) 
should be generated using a 
secure, crypto-quality random number generator.

The Hello message is encrypted using **the server's** public key.
The message to be encoded must not be longer than the length of modulus 
less twice the hash length plus 2.  As we use SHA1 the hash length is 
20 bytes, so for a 1024-bit = 128 byte RSA key the maximum message length
is 
	128 - (2 * 20 + 2) = 86 bytes
The hello message is 60 bytes long and so fits.  We recommend using 1024-bit
RSA keys for testing but 2048-bit or larger in production.

The Hello message is sent to the server over a TCP connection using its 
well-known address.  Conventionally the xlReg server listens on port 55555.

### Reply

The server decrypts the message using its private key - and the 
server's correctly encrypted reply proves to
the client that the server has that private key.  The server examines 
the message on receipt; 
if it is not well-formed the server silently discards it.  Otherwise the
server encrypts its reply using the AES IV and key from the Hello message.  
The server's reply consists of 

* iv2, the 16-byte IV to be used in further communications
* key2, the 32-byte AES key to be used in such communications
* salt2, an 8-byte random value
* salt1, the salt from the Hello message
* version2, a 4-byte little endian value

The first three fields should be generated by a secure random number generator.

The version number in the Hello message is a _proposed_ version number, 
the version preferred by the client.  The server will reply with the
version number that it prefers, and this is the protocol version that
will be used in subsequent messages.  In this implementation the server
simply ignores the version proposed by the client.

If the reply from the server cannot be decoded, or if salt1 does not
match the value in the Hello message, the client should silently close
the connection.

Otherwise iv2 and key2 will be used in further messages between this 
client and server.

## Protobuf Protocol

[xlReg Protobuf protocol](xlReg_protobuf.html)

## Registry Credentials

### RegCredRequest

### RegCredReply

## Client and OK

### Client Message

### OK Message

## Create and CreateReply

### Create Message

### CreateReply Message

## Join and JoinReply

### Join Message

### JoinReply Message

## GetCluster and ClusterMembers

### GetCluster Message

### ClusterMembers Message

## Bye and Ack

### Bye Message

### OK Message

## Error Message

