<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>xlReg_protocol</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" type="text/css" href="css/main.css" />
  <link rel="stylesheet" type="text/css" href="css/normalize.css" />
</head>
<body>
<h1>The XLReg Protocol</h1>

<h2>Hello and Reply</h2>

<p>All communications with the XLReg server must begin with a Hello/Reply
exchange, which verifies to the client the identity of the server and
establishes the AES IV and key used to encrypt further message
exchanges between the XLReg server and client.</p>

<h3>Version Numbers</h3>

<p>XLReg version numbers are 4-byte little-endian values.  These may be
thought of as <code>a.b.c.d</code>, where <code>a</code>, <code>b</code>, <code>c</code>, and <code>d</code> are unsigned byte values.
<code>d</code> is the lowest value and so will appear first in wire format.  When
serialized as strings, version numbers are conventionally written in
big-endian form, except that if the low-order fields are all zero, only
the high-order fields appear, so <code>1.2.0.0</code> will normally be written <code>1.2</code>
(but will appear on the wire as <code>0.0.2.1</code>.  Similarly <code>1.2.3.0</code> serializes
as <code>1.2.3</code> but appears on the wire as <code>0.3.2.1</code> and <code>1.2.3.4</code> appears on
the wire as `4.3.2.1.</p>

<h3>Hello</h3>

<p>XLReg communications begin when one machine, the <strong>client</strong>,
sends a Hello message to another, the <strong>server</strong> in this context.  The
Hello message consists of</p>

<ul>
<li>a 16-byte AES initialization vector (IV)</li>
<li>a 32-byte AES key</li>
<li>an 8 byte salt (random value)</li>
<li>a 4-byte little-endian version number</li>
</ul>

<p>AES is a block cipher used for high speed encryption.  AES has a standard
block size of 16 bytes.  The key is a whole number of such blocks.  The IV is
used to set up cipher-block chaining (CBC), a mode of operation in which
each block of plaintext is XORed with the previous block of ciphertext
before encryption.  The first block of plaintext has no previous block
of ciphertext, so an IV is used instead.</p>

<p>Clients should encrypt the message using RSA-OAEP, SHA1, and a 20-byte
random value, the oaepSalt.  No label is used.  In Go this is done using
    ciphertext,err = rsa.EncryptOAEP(sha, oaepSalt, ck, data, nil)
where <code>sha</code> represents an instance of the SHA1 hash function and <code>ck</code> is
an RSA public key.</p>

<p>In production all of the random values (IV, key, salt, and oaepSalt)
should be generated using a
secure, crypto-quality random number generator.</p>

<p>The Hello message is encrypted using <strong>the server&rsquo;s</strong> public key.
The message to be encoded must not be longer than the length of modulus
less twice the hash length plus 2.  As we use SHA1 the hash length is
20 bytes, so for a 1024-bit = 128 byte RSA key the maximum message length
is
    128 - (2 * 20 + 2) = 86 bytes
The hello message is 60 bytes long and so fits.  We recommend using 1024-bit
RSA keys for testing but 2048-bit or larger in production.</p>

<p>The Hello message is sent to the server over a TCP connection using its
well-known address.  Conventionally the xlReg server listens on port 55555.</p>

<h3>Reply</h3>

<p>The server decrypts the message using its private key - and the
server&rsquo;s correctly encrypted reply proves to
the client that the server has that private key.  The server examines
the message on receipt;
if it is not well-formed the server silently discards it.  Otherwise the
server encrypts its reply using the AES IV and key from the Hello message.<br />
The server&rsquo;s reply consists of</p>

<ul>
<li>iv2, the 16-byte IV to be used in further communications</li>
<li>key2, the 32-byte AES key to be used in such communications</li>
<li>salt2, an 8-byte random value</li>
<li>salt1, the salt from the Hello message</li>
<li>version2, a 4-byte little endian value</li>
</ul>

<p>The first three fields should be generated by a secure random number generator.</p>

<p>The version number in the Hello message is a <em>proposed</em> version number,
the version preferred by the client.  The server will reply with the
version number that it prefers, and this is the protocol version that
will be used in subsequent messages.  In this implementation the server
simply ignores the version proposed by the client.</p>

<p>If the reply from the server cannot be decoded, or if salt1 does not
match the value in the Hello message, the client should silently close
the connection.</p>

<p>Otherwise iv2 and key2 will be used in further messages between this
client and server.</p>

<h2>Protobuf Protocol</h2>

<p><a href="xlReg_protobuf.html">xlReg Protobuf protocol</a></p>

<h2>Registry Credentials</h2>

<p>Any XLReg server will profide credentials upon request.<br />
These are conventionally delivered as an ASCII file, <code>regCred.dat</code>,
containing</p>

<ul>
<li>the registry&rsquo;s name</li>
<li>its ID as a string of hex digits</li>
<li>its comms RSA public key in ssh format</li>
<li>its sig RSA public key in ssh format</li>
<li>its IP address and port</li>
<li>and the xlReg protocol version it is running.</li>
</ul>

<p>An example follows.</p>

<pre><code>
regCred {
    Name: xlReg
    ID: fc394d1363ce32e4cc6ae5e019bcc78176ad425014b01e906f8887eccb116664
    A
    CommsPubKey: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC1gaYZ9LtXq9uBeiP0jU6kqZrekd8GLdPMhENDmkxAoulh2+74WYN7AUo38hNZNjBT3VanMwZ2+QZNTfioNFbJnEdB5DvaC+/nSQ4B2i7qBdb2fWjXfLNAreB0R+oMWigFmUzooz5kQyk3jJZLxIoSLSDlyVUO2DWp2GDVU9FE2aVod3P7I8rI83OhU2K8/lrKBuLfQsVff+AJNCleu6raMNVzLgfCNsEKC9avXovX2qGhvZdQY/KZ7ZzrvIkOq03DJ3x6Vv37pCzRJtmxX04mk2CGTtqzliuzdarIVe+tvBbtE9dTRR9L8v2LKIhAr8JF+A3SPRPbcZJTxxsri+bR

    SigPubKey: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCeUamt6heiNhIJkLQUxXjnEh1iLhvwf6Rp+f2nCoBg0l1wDBpp2Qb4WBVRCNzGlwBWp+ZPd8YOGYBfqrhlkl/TPZ3xgm1IEbJ0Gh+TO8h1TlF/5zzIIrbdy5//jESad5Q3Cq2Ph7b+MH1W3tvdIWTQ24ht4qDWq0pjs8oV4fbcrNgnDCYjG5QqhTOHPRQ1ZZOLEH6p74BU+afweMimnFDYKjaQA1N328eT6gT6QeenesYy2at9Gkz0KHpE8AmpMTfk9KtjtH0HEMzaaH0+AsEF9fuAMR9B+w/HhlyRHeJYwZncVRFl1ELNZE51Th6S0BaXCJrEVqm7vaBDeKSe2Hrn

    EndPoints {
         TcpEndPoint: 127.0.0.1:44444
    }
    Version: 0.2.1
}
</code></pre>

<p>This particular registry is on the test machine (<em>localhost</em>, <code>127.0.0.1</code>) and
listens on <code>44444</code>, the port conventionally used for xlReg testing.</p>

<p>The <code>Go</code> version of the xlReg client provides functions to read and write
serialized RegCred files (<code>xlattice_go.reg.ParseRegCred()</code> and
<code>xlattice_go.reg.String()</code> respectively.</p>

<h2>Client and OK</h2>

<h3>Client Message</h3>

<h3>OK Message</h3>

<h2>Create and CreateReply</h2>

<h3>Create Message</h3>

<h3>CreateReply Message</h3>

<h2>Join and JoinReply</h2>

<h3>Join Message</h3>

<h3>JoinReply Message</h3>

<h2>GetCluster and ClusterMembers</h2>

<h3>GetCluster Message</h3>

<h3>ClusterMembers Message</h3>

<h2>Bye and Ack</h2>

<h3>Bye Message</h3>

<h3>OK Message</h3>

<h2>Error Message</h2>

<p><a href="LICENSE.html">LICENSE</a></p>
</body>
</html>
